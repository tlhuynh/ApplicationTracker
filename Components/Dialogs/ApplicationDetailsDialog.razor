@using System.ComponentModel.DataAnnotations
@using ApplicationTracker.Models
@using ApplicationTracker.Utilities.Enums

<MudDialog>
	<DialogContent>
		<MudStack Spacing="3">
			@*Company Name*@
			<MudTextField @bind-Value="_editModel.CompanyName" Typo="Typo.h4"
			              Label="Company Name" Variant="Variant.Text"
			              ReadOnly="@(!_isEditing)"/>
			@*Status*@
			@if (_isEditing) {
				<MudSelect @bind-Value="_editModel.Status" Variant="Variant.Outlined"
				           Label="Status" ReadOnly="@(!_isEditing)"
				           Clearable="false" Modal="true">
					@foreach (ApplicationStatus status in Enum.GetValues<ApplicationStatus>()) {
						<MudSelectItem Value="status">@status</MudSelectItem>
					}
				</MudSelect>
			} else {
				<MudField Label="Status" Variant="Variant.Outlined">
					<MudText>@_editModel.Status.ToString()</MudText>
				</MudField>
			}
			@*Applied Date*@
			<MudTextField @bind-Value="_editModel.AppliedDate" Label="Date Applied"
			              Format="yyyy-MM-dd" Variant="Variant.Outlined"
			              ReadOnly="@(!_isEditing)" InputType="InputType.Date"/>
			@*URL*@
			@if (_isEditing) {
				<MudTextField @bind-Value="_editModel.PostingURL" Label="Posting URL"
				              Lines="1" Variant="Variant.Outlined"
				              Placeholder="Add post URL for this application..."
				              Validation="@(new UrlAttribute() { ErrorMessage = "Invalid URL" })"
				              ReadOnly="false"/>
			} else {
				<MudField Label="Posting URL" Variant="Variant.Outlined">
					@if (!string.IsNullOrEmpty(_editModel.PostingURL)) {
						<MudLink Href="@_editModel.PostingURL" Target="_blank" Color="Color.Primary" Class="d-inline-flex align-center">
							@_editModel.PostingURL
							<MudIcon Icon="@Icons.Material.Filled.OpenInBrowser" Size="Size.Small" Class="mr-2"/>
						</MudLink>
					}
				</MudField>
			}
			@*notes*@
			<MudTextField @bind-Value="_editModel.Notes"
			              Label="Notes" Variant="Variant.Outlined" Lines="15"
			              Placeholder="Add notes about this application..."
			              HelperText="Document interview details, follow-ups, or any important information"
			              ReadOnly="@(!_isEditing)"/>
		</MudStack>
	</DialogContent>
	<DialogActions>
		@if (!_isEditing) {
			<MudIconButton Icon="@Icons.Material.Filled.Edit"
			               OnClick="@(() => _isEditing = true)"/>
		} else {
			<MudStack Row="true">
				<MudIconButton Icon="@Icons.Material.Filled.Cancel"
				               OnClick="@CancelEdit"></MudIconButton>
				<MudIconButton Icon="@Icons.Material.Filled.Save"
				               OnClick="@SaveEdit"></MudIconButton>
			</MudStack>
		}
	</DialogActions>
</MudDialog>

@code {
	[CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;

	[Parameter] public ApplicationRecord Application { get; set; } = null!;

	private ApplicationRecord _originalModel = null!;

	private ApplicationRecord _editModel = null!;

	private bool _isEditing;

	private bool _isEdited;

	protected override void OnParametersSet() {
		base.OnParametersSet();
		_originalModel = Application.Clone();
		_editModel = Application.Clone();
	}

	private void CancelEdit() {
		_isEditing = false;
		_editModel = _originalModel.Clone();
	}

	private void SaveEdit() {
		_isEditing = false;
		_isEdited = true;
		Application = _editModel;
	}

	// TODO
	// move the edit,cancel,save to the top
	// and add a regular close button at the bottom, remove option to close using x
}
