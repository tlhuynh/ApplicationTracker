@using System.ComponentModel.DataAnnotations
@using ApplicationTracker.Models
@using ApplicationTracker.Utilities.Enums

<MudDialog>
	<TitleContent>
		<MudText Typo="Typo.h4">Details</MudText>
	</TitleContent>
	<DialogContent>
		<MudStack Spacing="3">
			@*Company Name*@
			<MudTextField @bind-Value="Application.CompanyName" Typo="Typo.h6"
			              Label="Company Name" Variant="Variant.Text"
			              ReadOnly="@(!_isEditing)"/>
			@*Status*@
			@if (_isEditing) {
				<MudSelect @bind-Value="Application.Status" Variant="Variant.Outlined"
				           Label="Status" ReadOnly="@(!_isEditing)"
				           Clearable="false" Modal="true">
					@foreach (ApplicationStatus status in Enum.GetValues<ApplicationStatus>()) {
						<MudSelectItem Value="status">@status</MudSelectItem>
					}
				</MudSelect>
			} else {
				<MudField Label="Status" Variant="Variant.Outlined">
					<MudText>@Application.Status.ToString()</MudText>
				</MudField>
			}
			@*Applied Date*@
			<MudTextField @bind-Value="Application.AppliedDate" Label="Date Applied"
			              Format="yyyy-MM-dd" Variant="Variant.Outlined"
			              ReadOnly="@(!_isEditing)" InputType="InputType.Date"/>
			@*URL*@
			@if (_isEditing) {
				<MudTextField @bind-Value="Application.PostingURL" Label="Posting URL"
				              Lines="1" Variant="Variant.Outlined"
				              Placeholder="Add post URL for this application..."
				              Validation="@(new UrlAttribute() { ErrorMessage = "Invalid URL" })"
				              ReadOnly="false"/>
			} else {
				<MudField Label="Posting URL" Variant="Variant.Outlined">
					@if (!string.IsNullOrEmpty(Application.PostingURL)) {
						<MudLink Href="@Application.PostingURL" Target="_blank" Color="Color.Primary" Class="d-inline-flex align-center">
							@Application.PostingURL
							<MudIcon Icon="@Icons.Material.Filled.OpenInBrowser" Size="Size.Small" Class="mr-2"/>
						</MudLink>
					}
				</MudField>
			}
			@*notes*@
			<MudTextField @bind-Value="Application.Notes"
			              Label="Notes" Variant="Variant.Outlined" Lines="15"
			              Placeholder="Add notes about this application..."
			              HelperText="Document interview details, follow-ups, or any important information"
			              ReadOnly="@(!_isEditing)"/>
		</MudStack>
	</DialogContent>
	<DialogActions>
		@if (_isEditing) {
			<MudButton OnClick="@SaveEdit" Color="Color.Primary">Save</MudButton>
			<MudButton OnClick="@CancelEdit">Cancel</MudButton>
		} else {
			<MudButton OnClick="@StartEdit">Edit</MudButton>
			<MudButton OnClick="@CloseDialog">Close</MudButton>
		}
	</DialogActions>
</MudDialog>

@code {
	[CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;

	[Parameter] public ApplicationRecord Application { get; set; } = null!;

	private ApplicationRecord _originalModel = null!;

	private bool _isEditing;

	private bool _isEdited;

	protected override void OnParametersSet() {
		base.OnParametersSet();
		_originalModel = Application.Clone();
	}

	private void StartEdit() {
		_isEditing = true;
	}

	private void CancelEdit() {
		_isEditing = false;
		Application = _originalModel.Clone();
	}

	private void SaveEdit() {
		_isEditing = false;
		_isEdited = true;
		_originalModel = Application.Clone();
	}

	private void CloseDialog() {
		if (_isEdited) {
			MudDialog.Close(DialogResult.Ok(Application));
		} else {
			MudDialog.Cancel();
		}
	}
}
